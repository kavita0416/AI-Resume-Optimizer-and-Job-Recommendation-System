<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Upload Resume | Effective Resumes</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

<nav>
  <div class="nav-content">
    <div class="nav-logo">EFFECTIVE RESUMES</div>
    <ul class="nav-links">
      <li><a href="index.html#home">Home</a></li>
      <li><a href="index.html#templates">Templates</a></li>
      <li><a href="index.html#faq">FAQ</a></li>
      <li><a href="index.html#contact">Contact Us</a></li>
      <li><a href="login.html" class="btn-login">Login</a></li>
    </ul>
  </div>
</nav>

<main class="upload-section">
  <h2>Upload Your Resume</h2>
  <p>Select your resume file (PDF or DOCX) to analyze and get job recommendations.</p>

  <input type="file" id="resumeFile" accept=".pdf,.doc,.docx" />
  <button id="uploadBtn" class="btn-main">Upload</button>
  <p id="uploadStatus"></p>

  <div id="previewContainer"></div>

  <div id="atsCard" class="ats-card" style="display:none;">
    <div class="ats-row">
      <div class="ats-title">ATS Score</div>
      <div class="ats-score" id="atsScore">--</div>
    </div>
    <div class="ats-sub" id="atsNote">Analyzing your resume…</div>
    <ul class="ats-suggestions" id="atsSuggestions"></ul>
  </div>

  

  
  </div>

  <!-- place under the ATS card in upload.html -->
  <div id="recommendations" style="display:none; margin-top:16px;">
    <h3>Recommended Jobs</h3>
    <ul id="recommendationsList" style="padding-left:18px;"></ul>
  </div>
</main>

<footer>
  &copy; Resume Builder | Make your dream job possible!
</footer>


<script src="/front-config.js"></script>



<script>
(function () {
  // ------------------------------------------------------
  // ELEMENTS
  // ------------------------------------------------------
  const uploadBtn = document.getElementById("uploadBtn");
  const fileInput = document.getElementById("resumeFile");
  const uploadStatus = document.getElementById("uploadStatus");
  const previewContainer = document.getElementById("previewContainer");

  const atsCard = document.getElementById("atsCard");
  const atsScoreEl = document.getElementById("atsScore");
  const atsNoteEl = document.getElementById("atsNote");
  const atsSugEl = document.getElementById("atsSuggestions");

  const recRoot = document.getElementById("recommendations");
  const recList = document.getElementById("recommendationsList");


  // ------------------------------------------------------
  // HELPERS
  // ------------------------------------------------------

  function setStatus(msg, color) {
    uploadStatus.textContent = msg;
    uploadStatus.style.color = color || "#fff";
  }

  function getToken() {
    return localStorage.getItem("er_token") || localStorage.getItem("token");
  }

  function getApiBase() {
    return window.ER_API || window.API_BASE || "http://localhost:5000";
  }

  async function safeFetch(url, opts = {}) {
    const full = url.startsWith("http")
      ? url
      : `${getApiBase()}${url}`;

    const token = getToken();
    const headers = opts.headers || {};

    if (token) headers["Authorization"] = `Bearer ${token}`;

    return fetch(full, { ...opts, headers });
  }


  // ------------------------------------------------------
  // POLL ATS RESULT (Node → ML backend results saved in DB)
  // ------------------------------------------------------
  async function pollATS(resumeId) {
    let attempts = 0;

    atsCard.style.display = "block";
    atsNoteEl.textContent = "Processing resume…";
    atsScoreEl.textContent = "--";
    atsSugEl.innerHTML = "";

    while (attempts < 60) {
      attempts++;

      const res = await safeFetch(`/api/resumes/${resumeId}`);
      const data = await res.json();

      // Worker completed & ML result available
      if (data.status === "completed" && data.analysis) {
        const a = data.analysis;

        // Standardized ML result fields
        const atsScore =
          a.ats_score ||
          a.atsScore ||
          data.atsScore ||
          "--";

        const suggestions =
          a.improvement_tips ||
          a.suggestions ||
          data.improvementTips ||
          [];

        atsScoreEl.textContent = atsScore;
        atsNoteEl.textContent = "Analysis complete.";
        atsSugEl.innerHTML = suggestions.map(s => `<li>${s}</li>`).join("");

        // Load recommended jobs
        loadRecommendations(resumeId);
        return;
      }

      await new Promise(r => setTimeout(r, 2500));
    }

    atsNoteEl.textContent = "Timeout — ML backend took too long.";
  }


  // ------------------------------------------------------
  // LOAD JOB RECOMMENDATIONS
  // ------------------------------------------------------
  async function loadRecommendations(resumeId) {
  recRoot.style.display = "block";
  recList.innerHTML = `<li class="muted">Loading jobs…</li>`;

  try {
    const res = await safeFetch(`/api/resumes/recommendations/${resumeId}`);
    const json = await res.json();

    const list = json.recommendations || [];

    if (!Array.isArray(list) || list.length === 0) {
      recList.innerHTML = `<li class="muted">No recommendations available.</li>`;
      return;
    }

    recList.innerHTML = list
      .map(job => `
        <li>
          <strong>${job.title}</strong> — ${job.company}
          <br>Score: ${job.score}
          <br>Location: ${job.location || "N/A"}
          <br>
          <a href="${job.url}" target="_blank">Apply</a>
        </li>
      `)
      .join("");
  } catch (err) {
    recList.innerHTML = `<li class="muted">Error loading jobs</li>`;
  }
}



  // ------------------------------------------------------
  // MAIN UPLOAD HANDLER
  // ------------------------------------------------------
  uploadBtn.addEventListener("click", async () => {
    const file = fileInput.files?.[0];

    if (!file) return setStatus("Select a resume first", "red");

    const token = getToken();
    if (!token) return setStatus("Login required", "orange");

    uploadBtn.disabled = true;
    setStatus("Uploading...");

    const fd = new FormData();
    fd.append("resume", file);

    // 1) UPLOAD RESUME → NODE.JS
    const res = await safeFetch(`/api/resumes/upload`, {
      method: "POST",
      body: fd
    });

    const data = await res.json();

    if (!res.ok) {
      setStatus("Upload failed: " + (data.message || data.error), "red");
      uploadBtn.disabled = false;
      return;
    }

    const resumeId = data.resume?._id || data._id;
    const fileUrl = data.resume?.fileUrl || data.fileUrl;

    localStorage.setItem("uploaded_resume_id", resumeId);
    setStatus("Uploaded successfully!", "green");


    // PDF preview
    previewContainer.innerHTML = `
      <h3>Preview:</h3>
      <iframe src="${getApiBase()}${fileUrl}" width="100%" height="600"></iframe>
    `;


    // 2) TRIGGER ANALYSIS (Node → Worker → ML backend)
    await safeFetch(`/api/resumes/${resumeId}/analyze`, {
      method: "POST"
    });

    // 3) START POLLING ATS / ML RESULTS
    pollATS(resumeId);

    uploadBtn.disabled = false;
  });
})();
</script>




</body>
</html>
