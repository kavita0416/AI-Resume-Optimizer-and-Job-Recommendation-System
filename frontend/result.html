<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Resume Analysis & Recommendations</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* Small page-specific styles */
    main { max-width:1100px; margin:28px auto; padding:16px; color:#0b1220; }
    .layout { display:grid; grid-template-columns: 1fr 360px; gap:22px; align-items:start; }
    .previewBox { background:#111317; padding:18px; border-radius:10px; min-height:420px; display:flex; justify-content:center; align-items:center; }
    .previewBox iframe{ width:100%; height:640px; border:0; background:#fff; border-radius:6px; }
    .card { background:#0b1220; color:#cfe3ff; padding:14px; border-radius:12px; }
    .ats-score { font-size:28px; font-weight:800; color:#77ff9c; margin-top:8px; display:block; }
    .muted { color:#6b7280; }
    ul.recs { padding-left:18px; margin-top:8px; }
    .processing { color:#9fb3c8; margin-top:8px; }
    .link-job { color:#93c5fd; text-decoration:none; }
    .section-title { font-weight:700; margin-bottom:6px; color:#cfe3ff }
    .small-muted { font-size:0.9rem; color:#9aa7b8; margin-left:8px; }
    .btn-main { padding:8px 12px; border-radius:8px; background:#111827; color:#fff; border:0; cursor:pointer; }
    .btn[disabled] { opacity:0.6; cursor:not-allowed; }


    .previewBox {
    background: #111317;
    padding: 0;
    border-radius: 10px;
    height: 800px; /* set height of box */
    display: flex;
    align-items: center;
    justify-content: center;
}

#pdfPreview {
    width: 100%;
    height: 100%;
    border: none;
    object-fit: contain; /* ensures full clean fit */
}


    .layout {
        
        /* grid-template-columns: 1.3fr 1fr; */
        display: grid;
    grid-template-columns: 1fr 350px;
    align-items: stretch;
    }

    .left {
        width: 100%;
    }

    .right-sidebar {
    display: flex;
    flex-direction: column;
    gap: 20px;

    /* make it stretch to match left preview height */
    height: 100%;
}

.right-sidebar .card {
    width: 100%;
}

.right-sidebar {
    height: calc(100vh - 150px); /* adjust top spacing */
    overflow-y: auto;
    padding-right: 5px; /* avoid cutoff */
}





  </style>
</head>
<body>
  <nav>
    <div class="nav-content">
      <div class="nav-logo">EFFECTIVE RESUMES</div>
      <ul class="nav-links">
        <li><a href="index.html#home">Home</a></li>
        <li><a href="index.html#templates">Templates</a></li>
        <li><a href="index.html#faq">FAQ</a></li>
        <li><a href="index.html#contact">Contact</a></li>
        <li><a href="login.html" class="btn-login">Login</a></li>
      </ul>
    </div>
  </nav>

  <main>
    <h2>Resume Analysis & Recommendations</h2>
    <p class="muted">Preview your uploaded/generated PDF and view ATS score + job matches. This page auto-refreshes until analysis is available.</p>

    <div class="layout">
      <!-- left: preview iframe -->
      <div class="left">
        <h3 class="section-title">Preview:</h3>
        <div class="previewBox" id="previewBox">
            <!-- <iframe id="pdfPreview" class="previewIframe"></iframe> -->
            <object id="pdfPreview" type="application/pdf" class="previewIframe"></object>

        </div>

        <div style="margin-top:14px;">
            <button id="downloadBtn" class="btn-main">Download PDF</button>
            <button id="refreshBtn" class="btn ghost">Refresh</button>
            <span id="statusText" class="muted"></span>
        </div>
    </div>

      <!-- right: ATS card + recommendations -->
      <aside class="right-sidebar">
        <div class="card">
            <h3>ATS Score</h3>
            <div id="atsScore" class="score">--</div>
            <p id="atsStatus">Analyzing your resume...</p>
        </div>

        <div class="card">
            <h3>Recommended Jobs</h3>
            <ul id="jobList"></ul>
        </div>

        <div class="card">
            <h3>Skills</h3>
            <ul id="skillsList"></ul>
        </div>

        <div class="card">
            <h3>Improvement Tips</h3>
            <ul id="tipsList"></ul>
        </div>
    </aside>
    </div>
  </main>


<script>
(async () => {
    const API = window.ER_API || "http://localhost:5000";

    const urlParams = new URLSearchParams(window.location.search);
    let resumeId = urlParams.get("resumeId") || localStorage.getItem("uploaded_resume_id");

    const token = localStorage.getItem("er_token") || localStorage.getItem("token");

    if (!resumeId) {
        document.getElementById("pdfPreview").innerHTML = "No resume found.";
        return;
    }

    // -------------------------------
    // POLL RESUME STATUS
    // -------------------------------
    async function poll() {
        const res = await fetch(`${API}/api/resumes/${resumeId}`, {
            headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();

        // --- Preview PDF ---
        if (data.fileUrl) {
        const pdfURL = `${API}${data.fileUrl.startsWith("/") ? data.fileUrl : "/" + data.fileUrl}`;
        document.getElementById("pdfPreview").data = pdfURL;
      }


        // Still processing
        if (data.status !== "completed") {
            document.getElementById("atsStatus").innerText = "Analyzing your resume...";
            setTimeout(poll, 3000);
            return;
        }

        // -------------------------------
        // ATS Score + Skills + Tips
        // -------------------------------
        const analysis = data.analysis || {};

        document.getElementById("atsScore").innerText =
            analysis.ats_score ?? "--";

        document.getElementById("atsStatus").innerText = "Analysis complete.";

        document.getElementById("skillsList").innerHTML =
            (analysis.skills || [])
                .map(s => `<li>${s}</li>`)
                .join("");

        document.getElementById("tipsList").innerHTML =
            (analysis.improvement_tips || [])
                .map(t => `<li>${t}</li>`)
                .join("");

        // -------------------------------
        // Load Recommended Jobs
        // -------------------------------
        loadJobs();
    }

    async function loadJobs() {
        const res = await fetch(`${API}/api/resumes/recommendations/${resumeId}`, {
            headers: { Authorization: `Bearer ${token}` }
        });

        const jobs = await res.json();
        const list = document.getElementById("jobList");

        if (!jobs.recommendations || jobs.recommendations.length === 0) {
            list.innerHTML = "<li>No recommendations found.</li>";
            return;
        }

        list.innerHTML = jobs.recommendations.map(j => `
            <li>
                <strong>${j.title}</strong><br>
                ${j.company} â€” ${j.location}<br>
                Score: ${j.score}<br>
                <a target="_blank" href="${j.url}">Apply</a>
            </li>
        `).join("");
    }

    poll();

})();
</script>




</body>
</html>
